<!DOCTYPE html>
<html>

<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <link rel="stylesheet" href="css/flexboxgrid/flexboxgrid.min.css">
    <!-- Compiled and minified CSS -->
    <link rel="stylesheet" href="https://rawgit.com/EkispertWebService/GUI/ed686b9d12d/expGuiCourse/expCss/expGuiCourse.css">

    <link rel="stylesheet" href="index.css">
</head>


<body>

    <div class="container">
        <section class="page" id="top">
            <div class="center-box-top">
                <h1>Matatavi</h1>
                <p>説明</p>
                <a class="btn" onclick="scrollPage('#period')">START</a>
            </div>
        </section>
        <hr>
        <section class="page" id="period">
            <div class="center-box-period">
                <h4>日数</h4>
                <p>日数を選んでください</p>
                <p class="btn" id="period1" onclick="clickPeriod(0)">日帰り</p>
                <p class="btn" id="period2" onclick="clickPeriod(1)">1泊2日</p>
                <p class="btn" id="period3" onclick="clickPeriod(2)">2泊3日</p>
                <p class="btn" id="period4" onclick="clickPeriod(3)">3泊4日</p>
                <p class="btn" id="period5" onclick="clickPeriod(4)">4泊5日</p>
            </div>
        </section>
        <hr>
        <section class="page" id="keyword">
            <div class="center-box-keyword">
                <h4>キーワード</h4>
                <div class="row">
                    <input type="checkbox" name="keyword" value="温泉" id="key_onsen" checked/>
                    <label for="key_onsen">温泉</label>
                    <input type="checkbox" name="keyword" value="ホテル" id="key_hotel" />
                    <label for="key_hotel">ホテル</label>
                    <input type="checkbox" name="keyword" value="ペンション" id="key_pen" />
                    <label for="key_pen">ペンション</label>
                    <input type="checkbox" name="keyword" value="グルメ" id="key_guru" checked/>
                    <label for="key_gru">グルメ</label>
                    <input type="checkbox" name="keyword" value="買い物" id="key_shopping" />
                    <label for="key_shopping">買い物</label>
                    <input type="checkbox" name="keyword" value="海" id="key_sea" />
                    <label for="key_sea">海</label>
                    <input type="checkbox" name="keyword" value="山" id="key_mountain" />
                    <label for="key_mountain">山</label>
                    <input type="checkbox" name="keyword" value="歴史" id="key_history" checked/>
                    <label for="key_history">歴史</label>

                </div>
                <div class="row">
                    <a class="btn btn-make" onclick="clickMakeSiori()">しおり作成</a>
                </div>
            </div>
        </section>
        <hr>

        <section class="page" id="sioriPage">
            <div id="now-making">作成中</div>

            <div id="map" style="width:100%; height:300px"></div>

            <hr>
            <h4>しおり</h4>
            <section id="siori">
            </section>

        </section>

    </div>

    <!-- Compiled and minified JavaScript -->
    <script type="text/javascript" src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.100.2/js/materialize.min.js"></script>
    <script src="https://rawgit.com/EkispertWebService/GUI/ed686b9d12d/expGuiCourse/expGuiCourse.js"></script>

    <script type="text/javascript" charset="utf-8" src="https://map.yahooapis.jp/js/V1/jsapi?appid=dj00aiZpPW0zYXBCRWFrMDlZTyZzPWNvbnN1bWVyc2VjcmV0Jng9MmI-"></script>
    <script type="text/javascript">
        var ymap = new Y.Map("map");
        var startLat = 35.161089;
        var startLng = 136.882396;
        var latlngStart = new Y.LatLng(startLat, startLng);

        var nights = 0;

        window.onload = function () {
            scrollPage('#top');

            ymap.drawMap(latlngStart, 17, Y.LayerSetId.NORMAL);

            ymap.addControl(new Y.LayerSetControl());
            ymap.addControl(new Y.ScaleControl());
            ymap.addControl(new Y.SliderZoomControlHorizontal());
            // ymap.addControl(new Y.SearchControl());

        }

        // selector位置までスクロール
        function scrollPage(selector) {
            $("html,body").animate({
                scrollTop: $(selector).offset().top
            });
        }

        // 日数クリック
        function clickPeriod(n) {
            console.log("click nights = " + n);
            nights = n;

            $("#period1").removeClass("btn-checked");
            $("#period2").removeClass("btn-checked");
            $("#period3").removeClass("btn-checked");
            $("#period4").removeClass("btn-checked");
            $("#period5").removeClass("btn-checked");

            $("#period" + (n + 1)).addClass("btn-checked");

            scrollPage('#keyword');
        }

        // しおり作成クリック
        function clickMakeSiori() {
            scrollPage('#sioriPage');
            $('#now-making').show();

            var vLat = startLat;
            var vLng = startLng;
            // makeSiori(new Y.LatLng(35.161089, 136.882396));
            $.getJSON("https://www.cotogoto.ai/matatavi/sample", {
                    lat: vLat,
                    lng: vLng,
                    nights: 3,
                    keywords: "冒険",
                },
                function (data, status) {
                    console.log(data);
                    $('#now-making').hide();

                    //地図アニメーションスタート
                    startMapAnimation(data);
                }
            );
        }

        function startMapAnimation(data) {
            ymap.addFeature(new Y.Marker(latlngStart));
            nextMapAnimation(0, data);

        }

        function nextMapAnimation(count, data) {
            console.log("count:" + count);
            setTimeout(function () {
                var p = new Y.LatLng(data[count].lat, data[count].lng);
                if (count == 0)
                    ymap.setZoom(9, true, p, true);
                else
                    ymap.panTo(p, true);
                ymap.addFeature(new Y.Label(p, data[count].name1));
                ymap.addFeature(new Y.Marker(p));

                if (count + 1 < data.length) {
                    nextMapAnimation(count + 1, data);
                } else {
                    makeSioriAll(data);
                }
            }, 500);
        }

        function makeSioriAll(data) {
            elemPoint("出発", "", "keiro0");
            for (var i = 0; i < data.length; i++) {
                elemPoint(data[i].name1, data[i].descs, "keiro" + (i + 1));
            }
            elemPoint("到着", "", "goal");


            for (var i = 0; i < data.length; i++) {
                var nameFrom = "出発";
                if (i > 0) nameFrom = data[i - 1].name1;
                var nameTo = data[i].name1;
                var id = "keiro" + i;

                var latlng = [{
                        "lat": startLat,
                        "lng": startLng
                    },
                    {
                        "lat": data[i].lat,
                        "lng": data[i].lng
                    }
                ];
                if (i > 0) {
                    latlng[0].lat = data[i - 1].lat;
                    latlng[0].lng = data[i - 1].lng;
                }

                resultApp[i] = new expGuiCourse(document.getElementById(id));
                resultApp[i].setConfigure("key", accessKey);
                resultApp[i].setConfigure("ssl", true);
                resultApp[i].setConfigure("from", nameFrom);
                resultApp[i].setConfigure("to", nameTo);

                searchRun(resultApp[i], latlng);

            }

            var i = data.length;
            var nameFrom = data[i - 1].name1;
            var nameTo = "到着";
            var id = "keiro" + i;
            var latlng = [{
                    "lat": data[i - 1].lat,
                    "lng": data[i - 1].lng
                },
                {
                    "lat": startLat,
                    "lng": startLng
                }
            ];
            resultApp[i] = new expGuiCourse(document.getElementById(id));
            resultApp[i].setConfigure("key", accessKey);
            resultApp[i].setConfigure("ssl",
                true);
            resultApp[i].setConfigure("from", nameFrom);
            resultApp[i].setConfigure("to", nameTo);
            searchRun(resultApp[i], latlng);

        }

        function elemPoint(name, desc, id) {
            $('#siori').append(
                '<div class = "point" > ' +
                '<h3 class = "name" > ' + name + '</h3>' +
                '<div class = "desc" > ' + desc + ' </div>' +
                '</div>' +
                '<div id = "' + id + '">' + id + '</div>'
            );
        }

        function makeSiori(latlng) {
            ymap.addFeature(new Y.Marker(latlng));
            setTimeout(function () {
                var p = new Y.LatLng(34.9686991, 137.61252087);
                ymap.setZoom(9,
                    true, p, true);
                setTimeout(function () {
                    ymap.addFeature(new Y.Label(p, "松風苑"));
                    ymap.addFeature(new Y.Marker(p));
                    setTimeout(function () {
                        var p = new Y.LatLng(35.01470633, 138.9451893);
                        ymap.panTo(p, true);
                        setTimeout(function () {
                            ymap.addFeature(new Y.Label(p,
                                "大仁温泉"));
                            ymap.addFeature(new Y.Marker(p));
                            setTimeout(function () {
                                var p = new Y.LatLng(35.2047307,
                                    140.2819368);
                                ymap.panTo(p,
                                    true);
                                setTimeout(function () {
                                    ymap.addFeature(new Y.Label(
                                        p,
                                        "勝浦つるんつるん温泉"
                                    ));
                                    ymap.addFeature(new Y.Marker(
                                        p));
                                    searchRun(resultApp[0]);
                                    searchRun(resultApp[1]);
                                    searchRun(resultApp[2]);
                                }, 500);
                            }, 500);
                        }, 500);
                    }, 500);
                }, 500);
            }, 100);
        }

        var accessKey = "eBBWPyXMYduCN759";
        var resultApp = []; //経路結果表示パーツ

        /*
         * パーツを初期化
         */
        function init() {

            // 経路表示パーツ初期化
            resultApp[0] = new expGuiCourse(document.getElementById("result1"));
            resultApp[0].setConfigure("key", accessKey);
            resultApp[0].setConfigure("ssl", true);
            resultApp[0].setConfigure("from", "スタート地");
            resultApp[0].setConfigure("to", "ポイント１");
            resultApp[1] = new expGuiCourse(document.getElementById("result2"));
            resultApp[1].setConfigure("key", accessKey);
            resultApp[1].setConfigure("ssl",
                true);
            resultApp[1].setConfigure("from", "ポイント１");
            resultApp[1].setConfigure("to", "ポイント２");
            resultApp[2] = new expGuiCourse(document.getElementById("result3"));
            resultApp[2].setConfigure("key", accessKey);
            resultApp[2].setConfigure("ssl",
                true);
            resultApp[2].setConfigure("from", "ポイント２");
            resultApp[2].setConfigure("to", "ゴール");
        }

        /*
         * 探索ボタンの動作
         */
        function searchRun(obj, latlngs) {
            var searchWord = "";
            // 発着地リストを作成
            var viaList = "";
            viaList += latlngs[0].lat + "," + latlngs[0].lng + ",wgs84";
            viaList += ":";
            viaList += latlngs[1].lat + "," + latlngs[1].lng + ",wgs84";

            // 経路表示パーツ#1の場合
            searchWord += "viaList=" + viaList;
            // 探索種別 ※PLAIN固定
            searchWord += '&searchType=plain';

            // 探索を実行
            obj.search(searchWord, resultApp.PRICE_ONEWAY, function (isSuccess) {
                if (!isSuccess) {
                    alert("探索結果が取得できませんでした");
                }
            });
        }
    </script>
</body>

</html>